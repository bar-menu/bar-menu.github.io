<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Form Correzione</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Stili Base e Tipografia (come li avevi definiti) */
        html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; margin: 0; padding: 20px; background-color: var(--tg-theme-bg-color, #ffffff); color: var(--tg-theme-text-color, #000000); font-size: 17px; line-height: 1.6; }
        h2 { color: var(--tg-theme-text-color); border-bottom: 1px solid var(--tg-theme-hint-color); padding-bottom: 12px; margin-top: 0; margin-bottom: 25px; font-size: 1.4em; font-weight: 600; text-align: center; }
        label { display: block; margin-top: 20px; margin-bottom: 8px; font-weight: 500; font-size: 0.95em; color: var(--tg-theme-hint-color); }
        input[type="text"], input[type="date"], input[type="time"], textarea, select, div[contenteditable="true"].input { width: 100%; padding: 14px 12px; margin-top: 0; border: 1.5px solid var(--tg-theme-hint-color, #cccccc); border-radius: 10px; background-color: var(--tg-theme-secondary-bg-color, #f9f9f9); color: var(--tg-theme-text-color); box-sizing: border-box; font-size: 1em; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        select { padding: 14px 12px; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007AFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 12px auto; }
        input[readonly] { background-color: var(--tg-theme-secondary-bg-color, #eeeeee); opacity: 0.7; border-color: var(--tg-theme-hint-color, #dddddd); }
        input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus, textarea:focus, select:focus, div[contenteditable="true"].input:focus { border-color: var(--tg-theme-button-color, #2481CC); box-shadow: 0 0 0 3px var(--tg-theme-button-color-alpha, rgba(36, 129, 204, 0.25)); outline: none; }
        :root { --tg-theme-button-color-alpha: rgba(36, 129, 204, 0.25); --tg-theme-destructive-text-color-alpha: rgba(255, 77, 77, 0.25); }
        input.input-error, select.input-error, div[contenteditable="true"].input.input-error { border-color: var(--tg-theme-destructive-text-color, #ff4d4d) !important; box-shadow: 0 0 0 3px var(--tg-theme-destructive-text-color-alpha, rgba(255, 77, 77, 0.25)) !important; }
        .error-message { font-size: 0.8em; color: var(--tg-theme-destructive-text-color, #ff4d4d); margin-top: 4px; min-height: 1.2em;}
        textarea { min-height: 100px; resize: vertical; }
        /* Stili per il div contenteditable per farlo assomigliare agli altri input */
        div[contenteditable="true"].input {
            min-height: 50px; /* Ridotta altezza minima, simile ad altri input */
            line-height: 1.6; 
            -webkit-user-modify: read-write-plaintext-only; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
        }
        /* Placeholder per contenteditable */
        div[contenteditable="true"].input:empty::before {
            content: attr(data-placeholder);
            color: var(--tg-theme-hint-color, #999999);
            pointer-events: none; /* Permette il click "attraverso" il placeholder */
            display: block; /* Assicura che occupi spazio */
        }
        .info-summary { background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); padding: 15px; border-radius: 10px; margin-bottom: 25px; border: 1px solid var(--tg-theme-hint-color, #e0e0e0); }
        .info-summary p { margin: 5px 0 10px 0; font-size: 1em; display: flex; align-items: baseline; }
        .info-summary .info-label { font-weight: 500; color: var(--tg-theme-hint-color); margin-right: 8px; font-size: 0.9em; flex-shrink: 0; }
        .info-summary .info-value { font-weight: 600; color: var(--tg-theme-text-color); }
        #summaryEmployeeName.info-value { text-transform: uppercase; padding: 2px 6px; border-radius: 4px; font-size: 0.95em; }
        .info-summary .problem-details-container { margin: 5px 0 10px 0; font-size: 1em; display: flex; align-items: flex-start; }
        .problem-value-multiline #problemType, .problem-value-multiline #problemTime, .problem-value-multiline #problemDateText { display: block; line-height: 1.4;}
        .problem-value-multiline #problemTime { font-weight: normal; }
        .problem-value-multiline #problemDateText { font-weight: 600; }
        .field-group { margin-bottom: 20px; }
        .date-info-text { font-size: 0.8em; color: var(--tg-theme-hint-color); margin-top: 4px; font-style: italic; }
        #missingTimeDateContext { font-size: 0.85em; color: var(--tg-theme-hint-color); margin-left: 8px; font-style: italic; min-height: 1.2em;}
        .modal-button { background-color: var(--tg-theme-button-color, #2481CC); color: var(--tg-theme-button-text-color, #FFFFFF); padding: 14px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; transition: background-color 0.2s ease, opacity 0.2s ease, transform 0.1s ease; }
        .modal-button:hover:not(:disabled) { opacity: 0.85; }
        .modal-button:active:not(:disabled) { transform: scale(0.98); }
        #loadingMessage, #errorMessage { text-align: center; padding: 30px 20px; font-style: italic; font-size: 1em; color: var(--tg-theme-hint-color); }
        #errorMessage { color: var(--tg-theme-destructive-text-color, red); font-weight: bold; }
        #debugSection { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--tg-theme-hint-color); }
        #debugSection h3 { font-size: 1.1em; text-align: left; border-bottom: none; margin-bottom: 10px; }
        #debugSection p { font-size: 0.9em; margin: 5px 0; }
        #debugSection pre { background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); padding: 10px; border: 1px solid var(--tg-theme-hint-color, #e0e0e0); border-radius: 6px; font-size: 0.85em; word-wrap: break-word; white-space: pre-wrap; }
    </style>


</head>
<body style="visibility: hidden;">
    <div id="formContainer" style="display: none;">
        <h2>Form Correzione</h2>
        <div class="info-summary">
            <p><span class="info-label">Dipendente:</span><strong id="summaryEmployeeName" class="info-value">N/D</strong></p>
            <div class="problem-details-container">
                <span class="info-label">Problema:</span>
                <div id="summaryProblemFullDescription" class="info-value problem-value-multiline">
                    <span id="problemType">N/D</span>
                    <span id="problemTime">N/D</span>
                    <span id="problemDateText">N/D</span>
                </div>
            </div>
        </div>
        <form id="correctionForm">
            <!-- Input Nascosti -->
            <input type="hidden" id="problemContextIdInput" name="problemContextId">
            <input type="hidden" id="originalEmployeeNameInput" name="originalEmployeeName">
            <input type="hidden" id="originalProblemDateISOInput" name="originalProblemDateISO">
            <input type="hidden" id="originalSingleTimeInput" name="originalSingleTime">
            <input type="hidden" id="originalSingleBarInput" name="originalSingleBar">
            <input type="hidden" id="correctorUserIdInput" name="correctorUserId">
            <input type="hidden" id="correctorUserNameInput" name="correctorUserName">
            <input type="hidden" id="correctorUserFirstNameInput" name="correctorUserFirstName">
            <input type="hidden" id="correctorUserLastNameInput" name="correctorUserLastName">
            <input type="hidden" id="effectiveOriginalSolarDateISOInput" name="effectiveOriginalSolarDateISO">

            <!-- Sezione Correzione -->
            <div class="field-group" id="singleTimeCorrectionSection" style="display:none;">
                <label for="singleCorrectionAction">Aggiungere:</label>
                <select id="singleCorrectionAction" name="singleCorrectionAction">
                    <option value="isEntry_addExit">Uscita Mancante</option>
                    <option value="isExit_addEntry">Entrata Mancante</option>
                </select>
                <div id="singleCorrectionActionError" class="error-message" style="display:none;"></div>
            </div>

            <div class="field-group" id="missingTimeFieldGroup" style="display:none;">
                 <label for="missingTimeValue" id="missingTimeLabel">Orario Mancante (HH:MM):</label>
                 <input type="time" id="missingTimeValue" name="missingTimeValue">
                 <div id="missingTimeError" class="error-message" style="display:none;"></div>
            </div>
            
            <div class="field-group">
                <label for="notesTextField">Note:</label>
                <div class="input" contenteditable="true" data-placeholder="Aggiungi nota..." id="notesTextField"></div>
            </div>
        </form>
    </div>
    <div id="loadingMessage">Caricamento...</div>
    <div id="errorMessage" style="display:none;"></div>


    <script>
        try {
            const tg = window.Telegram.WebApp;
            const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzxAMul4wSZO6YVPGrsnhUJmqpUY2jDkgu2-qONZ27SjynWubJyJz_kZrUyBdNm4M9-OA/exec';
            
            let initialStartParamData = null;
            let currentUserDetails = {};
        
            document.addEventListener('DOMContentLoaded', main);
        
            function main() {
                // --- COLLEGAMENTO AGLI ELEMENTI DOM ---
                const formContainer = document.getElementById('formContainer');
                const loadingMessage = document.getElementById('loadingMessage');
                const errorMessageDiv = document.getElementById('errorMessage');
                const singleCorrectionActionSelect = document.getElementById('singleCorrectionAction');
                const missingTimeValueInput = document.getElementById('missingTimeValue');
                
                // --- INIZIALIZZAZIONE ---
                tg.ready();
                tg.expand();
                tg.MainButton.setText("INVIA CORREZIONE");
                tg.MainButton.onClick(handleFormSubmit);
                tg.BackButton.show();
                tg.BackButton.onClick(() => tg.close());
        
                if (tg.initDataUnsafe?.user) {
                    currentUserDetails = tg.initDataUnsafe.user;
                }
        
                singleCorrectionActionSelect.addEventListener('change', handleSingleCorrectionActionChange);
                missingTimeValueInput.addEventListener('input', updateMainButtonState);
                
                const startParam = tg.initDataUnsafe?.start_param || new URLSearchParams(window.location.search).get('tgWebAppStartParam');
                
                if (startParam) {
                    try {
                        const decodedJson = atob(startParam.replace(/_/g, '/').replace(/-/g, '+'));
                        const parsedData = JSON.parse(decodedJson);
                        populateUI(parsedData);
                    } catch (e) {
                        showFatalError(`Errore nel processare i dati di avvio: ${e.message}`);
                    }
                } else {
                    showFatalError("Parametro di avvio non trovato.");
                }
            }
        
            // --- FUNZIONI DI UTILITY ---
            function isValidTimeFormat(timeString) { return timeString && /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString); }
            function formatDate_DDMMYYYY(dateStrYYYYMMDD) { if (!dateStrYYYYMMDD) return ""; const parts = dateStrYYYYMMDD.split('-'); return parts.length === 3 ? `${parts[2]}/${parts[1]}/${parts[0]}` : dateStrYYYYMMDD; }
            function G_addDaysToISONoTime(isoDateString, days) { if (!isoDateString) return ""; try { const date = new Date(`${isoDateString}T12:00:00Z`); date.setUTCDate(date.getUTCDate() + days); return date.toISOString().split('T')[0]; } catch (e) { return isoDateString; } }
            function showFatalError(message) {
                document.getElementById('loadingMessage').style.display = 'none';
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = "ERRORE: " + message;
                errorDiv.style.display = 'block';
                tg.MainButton.hide();
                document.body.style.visibility = 'visible';
            }
        
            // --- LOGICA PRINCIPALE ---
        
            function populateUI(data) {
                initialStartParamData = data;
                
                // Popola i campi visibili e nascosti di base
                document.getElementById('summaryEmployeeName').textContent = data.name || 'N/D';
                document.getElementById('problemContextIdInput').value = data.ctxId || '';
                document.getElementById('originalEmployeeNameInput').value = data.name || '';
                document.getElementById('originalProblemDateISOInput').value = data.pDateISO || '';
                document.getElementById('problemDateText').textContent = `(Giorno Lavorativo: ${formatDate_DDMMYYYY(data.pDateISO)})`;
        
                const problemType = data.pType ? data.pType.toUpperCase() : 'GENERIC_ERROR';
                let mainProblemDescriptionUI = "Problema Rilevato";
                switch (problemType) {
                    case 'SINGLE_TIMESTAMP': mainProblemDescriptionUI = "Timbratura singola"; break;
                    case 'DURATION_TOO_SHORT_1H': mainProblemDescriptionUI = "Durata servizio < 1 ora"; break;
                }
                document.getElementById('problemType').textContent = mainProblemDescriptionUI;
        
                function setAnchor(time, bar) {
                    document.getElementById('originalSingleTimeInput').value = time || '';
                    document.getElementById('originalSingleBarInput').value = bar || '';
                    document.getElementById('problemTime').textContent = time ? `${time} (Bar ${bar || 'N/D'})` : "Dettaglio non disponibile.";
                }
        
                // Logica per gestire i diversi tipi di errore
                if (problemType === 'DURATION_TOO_SHORT_1H' && data.endTime) {
                    document.getElementById('singleTimeCorrectionSection').style.display = 'block';
                    const actionSelect = document.getElementById('singleCorrectionAction');
                    actionSelect.onchange = () => {
                        if (actionSelect.value === 'isExit_addEntry') {
                            setAnchor(data.endTime, data.endBar);
                        } else {
                            setAnchor(data.origTime, data.origBar);
                        }
                    };
                    actionSelect.value = 'isEntry_addExit'; // Default
                    setAnchor(data.origTime, data.origBar); // Imposta ancora iniziale
                } else { // SINGLE_TIMESTAMP o altro
                    document.getElementById('singleTimeCorrectionSection').style.display = 'block';
                    setAnchor(data.origTime, data.origBar);
                }
        
                handleSingleCorrectionActionChange();
                updateMainButtonState();
                document.getElementById('formContainer').style.display = 'block';
                document.body.style.visibility = 'visible';
            }
        
            function handleSingleCorrectionActionChange() {
                const action = document.getElementById('singleCorrectionAction').value;
                const missingTimeGroup = document.getElementById('missingTimeFieldGroup');
                if (action) {
                    missingTimeGroup.style.display = 'block';
                    document.getElementById('missingTimeLabel').textContent = (action === 'isExit_addEntry') ? "Orario Entrata Mancante:" : "Orario Uscita Mancante:";
                } else {
                    missingTimeGroup.style.display = 'none';
                }
                updateMainButtonState();
            }
        
            function updateMainButtonState() {
                if (!tg.MainButton) return;
                const action = document.getElementById('singleCorrectionAction').value;
                const time = document.getElementById('missingTimeValue').value;
                if (action && isValidTimeFormat(time)) {
                    tg.MainButton.enable().show();
                } else {
                    tg.MainButton.disable().hide();
                }
            }
        
            function handleFormSubmit() {
                if (tg.MainButton.isProgressVisible) return;
                updateMainButtonState(); // Riesegue la validazione
                if (!tg.MainButton.isActive) {
                    tg.showAlert("Per favore, completa il form correttamente.");
                    return;
                }
        
                tg.showConfirm("Confermi l'invio della correzione?", (isConfirmed) => {
                    if (isConfirmed) {
                        tg.MainButton.showProgress().disable();
                        const dataToSend = {
                            problemContextId: document.getElementById('problemContextIdInput').value,
                            originalEmployeeName: document.getElementById('originalEmployeeNameInput').value,
                            originalProblemDateISO: document.getElementById('originalProblemDateISOInput').value,
                            originalSingleTime: document.getElementById('originalSingleTimeInput').value,
                            originalSingleBar: document.getElementById('originalSingleBarInput').value,
                            singleCorrectionAction: document.getElementById('singleCorrectionAction').value,
                            missingTimeValue: document.getElementById('missingTimeValue').value,
                            notes: document.getElementById('notesTextField').textContent.trim(),
                            initDataRaw: tg.initData,
                            correctorUserInfo: currentUserDetails,
                        };
                        fetch(GAS_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ payload: dataToSend }) })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === "successo") {
                                    tg.close();
                                } else {
                                    tg.showAlert(`Errore: ${data.message}`);
                                    tg.MainButton.hideProgress();
                                    updateMainButtonState();
                                }
                            })
                            .catch(error => {
                                tg.showAlert(`Errore di rete: ${error.message}`);
                                tg.MainButton.hideProgress();
                                updateMainButtonState();
                            });
                    }
                });
            }
        
        } catch (e) {
            // Errore globale di inizializzazione
            document.body.style.visibility = 'visible';
            document.getElementById('loadingMessage').style.display = 'none';
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = `Errore critico: ${e.message}`;
                errorDiv.style.display = 'block';
            }
        }
        </script>
        </body>
        </html>