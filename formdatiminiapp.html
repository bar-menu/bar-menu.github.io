<!DOCTYPE html>
<html>
<head>
    <base target="_top"> <!-- Utile se servi da GAS, ma non dannoso qui -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Form Correzione</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Stili Base e Tipografia (come li avevi definiti) */
        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
            box-sizing: border-box;
        }

        *, *:before, *:after {
            box-sizing: inherit;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 20px;
            background-color: var(--tg-theme-bg-color, #ffffff); /* Default per browser normali */
            color: var(--tg-theme-text-color, #000000);       /* Default per browser normali */
            font-size: 17px;
            line-height: 1.6;
        }

        h2 {
            color: var(--tg-theme-text-color);
            border-bottom: 1px solid var(--tg-theme-hint-color);
            padding-bottom: 12px;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.4em;
            font-weight: 600;
            text-align: center;
        }

        label {
            display: block;
            margin-top: 20px;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95em;
            color: var(--tg-theme-hint-color);
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 14px 12px;
            margin-top: 0;
            border: 1.5px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 10px;
            background-color: var(--tg-theme-secondary-bg-color, #f9f9f9);
            color: var(--tg-theme-text-color);
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        select {
            padding: 14px 12px; /* Allineato con gli altri input */
        }

        input[readonly] {
            background-color: var(--tg-theme-secondary-bg-color, #eeeeee);
            opacity: 0.7;
            border-color: var(--tg-theme-hint-color, #dddddd);
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--tg-theme-button-color, #2481CC);
            box-shadow: 0 0 0 3px var(--tg-theme-button-color-alpha, rgba(36, 129, 204, 0.25)); /* Custom property per alpha */
            outline: none;
        }
        /* Proprietà custom per alpha dei colori Telegram */
        :root {
             --tg-theme-button-color-alpha: rgba(36, 129, 204, 0.25); /* Esempio, da aggiornare dinamicamente se possibile */
             --tg-theme-destructive-text-color-alpha: rgba(255, 77, 77, 0.25); /* Esempio */
        }


        input.input-error {
            border-color: var(--tg-theme-destructive-text-color, #ff4d4d) !important;
            box-shadow: 0 0 0 3px var(--tg-theme-destructive-text-color-alpha, rgba(255, 77, 77, 0.25)) !important;
        }
        .error-message {
            font-size: 0.8em;
            color: var(--tg-theme-destructive-text-color, #ff4d4d);
            margin-top: 4px;
        }


        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .info-summary {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .info-summary p {
            margin: 5px 0 10px 0;
            font-size: 1em;
            display: flex;
            align-items: baseline;
        }

        .info-summary .info-label {
            font-weight: 500;
            color: var(--tg-theme-hint-color);
            margin-right: 8px;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .info-summary .info-value {
            font-weight: 600;
            color: var(--tg-theme-text-color);
        }

        #summaryEmployeeName.info-value {
            text-transform: uppercase;
            /* background-color: var(--tg-theme-hint-color, #e9ecef); */ /* Potrebbe non essere ideale con tutti i temi */
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.95em;
        }

        .info-summary .problem-details-container {
            margin: 5px 0 10px 0;
            font-size: 1em;
            display: flex;
            align-items: flex-start; /* Allinea all'inizio se il testo è multiriga */
        }

        .problem-value-multiline #problemType,
        .problem-value-multiline #problemTime,
        .problem-value-multiline #problemDateText {
            display: block;
        }
        .problem-value-multiline #problemTime {
            font-weight: normal; /* O 600 se preferisci */
        }


        .field-group {
            margin-bottom: 20px;
        }

        .date-info-text {
            font-size: 0.8em;
            color: var(--tg-theme-hint-color);
            margin-top: 4px;
            font-style: italic;
        }
        #missingTimeDateContext {
            font-size: 0.85em;
            color: var(--tg-theme-hint-color);
            margin-left: 8px;
            font-style: italic;
        }

        #submitHtmlButton, .modal-button {
            background-color: var(--tg-theme-button-color, #2481CC);
            color: var(--tg-theme-button-text-color, #FFFFFF);
            padding: 14px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.2s ease, opacity 0.2s ease;
        }
        #submitHtmlButton {
            padding: 16px 20px;
            font-size: 1.1em;
            font-weight: 600;
            width: 100%;
            margin-top: 30px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #addNotesButton {
            background-color: transparent;
            color: var(--tg-theme-hint-color, #707579);
            border: 1.5px solid var(--tg-theme-hint-color, #adb5bd);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            width: auto;
            display: inline-block;
            margin-top: 10px;
            margin-bottom: 5px;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        #addNotesButton:hover:not(:disabled) {
             background-color: var(--tg-theme-secondary-bg-color, rgba(0,0,0,0.05));
             border-color: var(--tg-theme-text-color);
             color: var(--tg-theme-text-color);
        }

        #submitHtmlButton:hover:not(:disabled),
        .modal-button:hover:not(:disabled) {
            opacity: 0.85;
        }
        #submitHtmlButton:active:not(:disabled) {
            transform: scale(0.98);
        }
        #submitHtmlButton:disabled {
            background-color: var(--tg-theme-hint-color, #cccccc); /* Usa hint color per disabilitato */
            color: var(--tg-theme-secondary-bg-color, #666666); /* Testo più scuro su sfondo chiaro */
            cursor: not-allowed;
            opacity: 0.7;
        }

        #loadingMessage, #errorMessage {
            text-align: center;
            padding: 30px 20px;
            font-style: italic;
            font-size: 1em;
            color: var(--tg-theme-hint-color);
        }
        #errorMessage {
            color: var(--tg-theme-destructive-text-color, red);
            font-weight: bold;
        }


        #dateCorrectionGroup { /* Mantenuto per riferimento, la logica JS lo gestirà */
            /* display: none !important; */ /* Rimuovi !important, gestito da JS */
        }

        /* Styles for Notes Modal */
        .modal-overlay {
            display: none; /* Nascosto di default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); /* Sfondo semi-trasparente */
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: var(--tg-theme-text-color);
        }
        .modal-content textarea {
            width: 100%;
            min-height: 80px;
            margin-bottom: 15px;
            border-color: var(--tg-theme-hint-color);
            background-color: var(--tg-theme-bg-color); /* Sfondo input modale */
        }
        .modal-content label {
            margin-top: 0;
            margin-bottom: 5px;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        .modal-button.secondary {
            background-color: var(--tg-theme-hint-color, #ccc);
            color: var(--tg-theme-text-color, #333);
        }
        #currentNotesDisplay {
            font-size: 0.9em;
            color: var(--tg-theme-text-color);
            margin-top: 0px;
            padding: 8px;
            background-color: var(--tg-theme-bg-color);
            border-radius: 6px;
            border: 1px dashed var(--tg-theme-hint-color, #e0e0e0);
            min-height: 20px;
            white-space: pre-wrap; /* Per rispettare a capo nelle note */
            word-wrap: break-word; /* Per andare a capo con parole lunghe */
        }
         #currentNotesDisplay.empty {
            font-style: italic;
            color: var(--tg-theme-hint-color);
        }

        /* Debug Section Styling */
        #debugSection {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--tg-theme-hint-color);
        }
        #debugSection h3 {
            font-size: 1.1em;
            text-align: left;
            border-bottom: none;
            margin-bottom: 10px;
        }
        #debugSection p {
            font-size: 0.9em;
            margin: 5px 0;
        }
        #debugSection pre {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 10px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 6px;
            font-size: 0.85em;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

    </style>
</head>
<body>
    <div id="formContainer" style="display: none;"> <!-- Nascosto finché i dati non sono pronti -->
        <h2>Form Correzione</h2>

        <div class="info-summary">
            <p>
                <span class="info-label">Dipendente:</span>
                <strong id="summaryEmployeeName" class="info-value">N/D</strong>
            </p>
            <div class="problem-details-container">
                <span class="info-label">Problema:</span>
                <div id="summaryProblemFullDescription" class="info-value problem-value-multiline">
                    <span id="problemType">N/D</span>
                    <span id="problemTime">N/D</span>
                    <span id="problemDateText">N/D</span>
                </div>
            </div>
        </div>

        <form id="correctionForm">
            <!-- Campi Nascosti per passare dati originali e note -->
            <input type="hidden" id="problemIdInput" name="problemId">
            <input type="hidden" id="originalEmployeeNameInput" name="originalEmployeeName">
            <input type="hidden" id="originalProblemDateISOInput" name="originalProblemDateISO">
            <input type="hidden" id="originalSingleTimeInput" name="originalSingleTime">
            <input type="hidden" id="notesHiddenInput" name="notes">

            <!-- Sezione Correzione Data (nascosta di default) -->
            <div class="field-group" id="dateCorrectionGroup" style="display:none;">
                <label for="correctedDate">Data Corretta (lascia vuoto per deduzione):</label>
                <input type="date" id="correctedDate" name="correctedDate">
                <p class="date-info-text">La data verrà dedotta automaticamente se possibile.</p>
            </div>

            <!-- Sezione per Problemi di Orario Singolo (nascosta di default) -->
            <div class="field-group" id="singleTimeCorrectionSection" style="display:none;">
                <label for="singleCorrectionAction">Aggiungi uscita o ingresso mancante:</label>
                <select id="singleCorrectionAction" name="singleCorrectionAction">
                    <option value="">-- Seleziona un'azione --</option>
                    <option value="isEntry_addExit">Uscita Mancante</option>
                    <option value="isExit_addEntry">Entrata Mancante</option>
                </select>
            </div>

            <!-- Campo Orario Mancante (nascosto di default) -->
            <div class="field-group" id="missingTimeFieldGroup" style="display:none;">
                <div style="display: flex; align-items: center;">
                    <div style="flex-grow: 1;">
                        <label for="missingTimeValue" id="missingTimeLabel">Orario Mancante (HH:MM):</label>
                        <input type="time" id="missingTimeValue" name="missingTimeValue">
                        <div id="missingTimeError" class="error-message" style="display:none;"></div>
                    </div>
                    <span id="missingTimeDateContext"></span>
                </div>
            </div>

            <!-- Sezione Note -->
            <div class="field-group">
                <button type="button" id="addNotesButton">Aggiungi Note (opzionale)</button>
                <div id="currentNotesDisplay" class="empty">Nessuna nota.</div>
            </div>

            <!-- Pulsante di Invio -->
            <div class="field-group" style="margin-top: 30px;">
                <button type="button" id="submitHtmlButton">Invia Correzione</button>
            </div>
        </form>
    </div>

    <!-- Modale per le Note -->
    <div id="notesModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <label for="notesTextareaModal">Inserisci le tue note:</label>
            <textarea id="notesTextareaModal" name="notesTextareaModal" rows="4"></textarea>
            <div class="modal-buttons">
                <button type="button" id="cancelNotesButton" class="modal-button secondary">Annulla</button>
                <button type="button" id="saveNotesButton" class="modal-button">Salva Note</button>
            </div>
        </div>
    </div>

    <!-- Messaggio di Caricamento/Errore Iniziale -->
    <div id="loadingMessage">Caricamento dati...</div>
    <div id="errorMessage" style="display:none;"></div>

    <!-- Sezione Debug (verrà popolata da JavaScript) -->
    <div id="debugSection" style="display: none;"> <!-- Nascosta di default, mostrala se in modalità debug -->
        <!-- Il contenuto verrà aggiunto da JS -->
    </div>

<!-- Inserisci questo intero blocco <script>...</script> 
     alla fine del tuo <body>, prima di </body> 
     nel file formdatiminiapp.html che carichi su GitHub Pages -->

     <script>
        // Inizio Blocco JavaScript
        document.addEventListener('DOMContentLoaded', function () {
            const tg = window.Telegram.WebApp;
            // IMPORTANTISSIMO: Sostituisci con il VERO URL del tuo Google Apps Script Web App distribuito!
            const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby2qm7YA_UPHA1TAz2UYRLEzL5uukraSYQXYaC5t8dxHVydezV3pvi-xawyf9qHr4lg/exec';
    
            // --- Cache degli Elementi DOM ---
            const formContainer = document.getElementById('formContainer');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessageDiv = document.getElementById('errorMessage');
            const correctionForm = document.getElementById('correctionForm');
    
            const summaryEmployeeName = document.getElementById('summaryEmployeeName');
            const summaryProblemType = document.getElementById('problemType');
            const summaryProblemTime = document.getElementById('problemTime');
            const summaryProblemDateText = document.getElementById('problemDateText');
    
            const problemIdInput = document.getElementById('problemIdInput');
            const originalEmployeeNameInput = document.getElementById('originalEmployeeNameInput');
            const originalProblemDateISOInput = document.getElementById('originalProblemDateISOInput');
            const originalSingleTimeInput = document.getElementById('originalSingleTimeInput');
            const notesHiddenInput = document.getElementById('notesHiddenInput');
    
            const correctedDateInput = document.getElementById('correctedDate');
            const singleCorrectionActionSelect = document.getElementById('singleCorrectionAction');
            const missingTimeValueInput = document.getElementById('missingTimeValue');
            const missingTimeLabel = document.getElementById('missingTimeLabel');
            const missingTimeDateContext = document.getElementById('missingTimeDateContext');
            const missingTimeError = document.getElementById('missingTimeError');
    
            const dateCorrectionGroup = document.getElementById('dateCorrectionGroup');
            const singleTimeCorrectionSection = document.getElementById('singleTimeCorrectionSection');
            const missingTimeFieldGroup = document.getElementById('missingTimeFieldGroup');
    
            const addNotesButton = document.getElementById('addNotesButton');
            const currentNotesDisplay = document.getElementById('currentNotesDisplay');
            const notesModalOverlay = document.getElementById('notesModalOverlay');
            const notesTextareaModal = document.getElementById('notesTextareaModal');
            const saveNotesButton = document.getElementById('saveNotesButton');
            const cancelNotesButton = document.getElementById('cancelNotesButton');
    
            const submitHtmlButton = document.getElementById('submitHtmlButton');
            const debugSection = document.getElementById('debugSection');
    
            let initialStartParamData = null; // Per conservare i dati originali del start_param
            let isDebugMode = false;          // Per mostrare la sezione debug
            let currentTelegramUserId = "USER_ID_NON_ANCORA_LETTO";
    
    
            // --- Funzioni Utilità ---
            function hexToRgba(hex, alpha) {
                if (!hex || typeof hex !== 'string') hex = '#000000'; // Default nero se hex non valido
                hex = hex.replace('#', '');
                const r = parseInt(hex.substring(0, 2), 16) || 0;
                const g = parseInt(hex.substring(2, 4), 16) || 0;
                const b = parseInt(hex.substring(4, 6), 16) || 0;
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
    
            function applyThemeVariables() {
                const rootStyle = document.documentElement.style;
                const buttonColor = tg.themeParams.button_color || '#2481CC';
                const destructiveColor = tg.themeParams.destructive_text_color || '#ff4d4d';
                rootStyle.setProperty('--tg-theme-button-color-alpha', hexToRgba(buttonColor, 0.25));
                rootStyle.setProperty('--tg-theme-destructive-text-color-alpha', hexToRgba(destructiveColor, 0.25));
            }
    
            function showFatalError(message) {
                console.error("ERRORE FATALE:", message);
                if (loadingMessage) loadingMessage.style.display = 'none';
                if (formContainer) formContainer.style.display = 'none';
                if (errorMessageDiv) {
                    errorMessageDiv.textContent = message;
                    errorMessageDiv.style.display = 'block';
                }
                if (debugSection) debugSection.style.display = 'block'; // Mostra sempre debug in caso di errore fatale
                updateDebugSection("ERRORE FATALE: " + message, null, null, null, null);
            }
    
            function base64UrlDecode(str) {
                if (!str || typeof str !== 'string' || str.trim() === "") return null;
                try {
                    let base64 = str.replace(/-/g, '+').replace(/_/g, '/');
                    while (base64.length % 4) { base64 += '='; }
                    return decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                } catch (e) {
                    console.error("Errore nella decodifica base64url:", e, "Stringa:", str);
                    return null;
                }
            }
    
            function parseStartParam(startParamString) {
                if (!startParamString || startParamString === "Nessuno" || startParamString.trim() === "") {
                    console.warn("startParamString è vuoto o 'Nessuno'.");
                    return { error: "Parametro di avvio mancante o vuoto." };
                }
                const decodedJsonString = base64UrlDecode(startParamString);
                if (!decodedJsonString) {
                     return { error: "Decodifica del parametro di avvio fallita.", rawValue: startParamString };
                }
                try {
                    return JSON.parse(decodedJsonString);
                } catch (e) {
                    console.error("Errore nel parsing del JSON decodificato:", e, "JSON Decodificato:", decodedJsonString);
                    return { error: "Formato dati del parametro di avvio non valido.", rawValue: startParamString, decodedValue: decodedJsonString };
                }
            }
    
            function populateUI(data) {
                if (!data || data.error) {
                    const errorMsg = `Errore nel caricare i dati iniziali: ${data ? (data.error + (data.rawValue ? ` (Grezzo: ${data.rawValue.substring(0,50)}...)` : (data.decodedValue ? ` (Decodificato: ${data.decodedValue.substring(0,50)}...)` : ''))) : 'Nessun dato o formato sconosciuto.'}`;
                    showFatalError(errorMsg);
                    tg.showAlert(errorMsg.substring(0, 200)); // Limita lunghezza alert
                    return;
                }
                initialStartParamData = data; // Salva i dati originali
                console.log("Dati iniziali parsati per UI:", initialStartParamData);
    
                if (summaryEmployeeName) summaryEmployeeName.textContent = data.employeeName || 'N/D';
                if (summaryProblemType) summaryProblemType.textContent = data.problemDescription || 'N/D';
                if (summaryProblemTime) summaryProblemTime.textContent = data.problemTime || '';
                if (summaryProblemDateText) summaryProblemDateText.textContent = data.problemDate || '';
    
                if (problemIdInput) problemIdInput.value = data.problemId || '';
                if (originalEmployeeNameInput) originalEmployeeNameInput.value = data.employeeName || '';
                if (originalProblemDateISOInput) originalProblemDateISOInput.value = data.problemDateISO || '';
                if (originalSingleTimeInput) originalSingleTimeInput.value = data.originalSingleTime || '';
    
                if (dateCorrectionGroup) dateCorrectionGroup.style.display = 'none';
                if (singleTimeCorrectionSection) singleTimeCorrectionSection.style.display = 'none';
                if (missingTimeFieldGroup) missingTimeFieldGroup.style.display = 'none';
    
                if (data.problemType === 'SINGLE_MISSING_ENTRY' || data.problemType === 'SINGLE_MISSING_EXIT') {
                    if (singleTimeCorrectionSection) singleTimeCorrectionSection.style.display = 'block';
                    if (missingTimeFieldGroup) missingTimeFieldGroup.style.display = 'block';
                    if (singleCorrectionActionSelect) {
                         singleCorrectionActionSelect.value = (data.problemType === 'SINGLE_MISSING_ENTRY') ? 'isExit_addEntry' : 'isEntry_addExit';
                    }
                    if (missingTimeLabel) {
                        missingTimeLabel.textContent = (data.problemType === 'SINGLE_MISSING_ENTRY') ? "Orario Entrata Mancante (HH:MM):" : "Orario Uscita Mancante (HH:MM):";
                    }
                    if (missingTimeDateContext) missingTimeDateContext.textContent = `per il giorno ${data.problemDateFormatted || data.problemDateISO || 'N/A'}`;
                } else if (data.problemType === 'DATE_CORRECTION_NEEDED') {
                    if (dateCorrectionGroup) dateCorrectionGroup.style.display = 'block';
                }
    
                if (loadingMessage) loadingMessage.style.display = 'none';
                if (errorMessageDiv) errorMessageDiv.style.display = 'none';
                if (formContainer) formContainer.style.display = 'block';
            }
    
            function updateDebugSection(startParamVal, parsedDataObj, initDataStr, initDataUnsafeObj, locationSearchStr) {
                if (!debugSection) return;
                debugSection.innerHTML = `
                    <h3>Debug Dati Telegram Ricevuti:</h3>
                    <p><strong>Parametro Start (valore grezzo ricevuto):</strong></p><pre>${startParamVal === undefined ? "undefined" : (startParamVal === null ? "null" : String(startParamVal))}</pre>
                    <p><strong>Dati Parsati da Start Param (se JSON):</strong></p><pre>${parsedDataObj ? JSON.stringify(parsedDataObj, null, 2) : "N/D o errore parsing"}</pre>
                    <p><strong>initData (grezzo):</strong></p><pre>${initDataStr || "Non presente"}</pre>
                    <p><strong>initDataUnsafe (JSON):</strong></p><pre>${initDataUnsafeObj ? JSON.stringify(initDataUnsafeObj, null, 2) : "Non presente"}</pre>
                    <p><strong>URL Search (window.location.search):</strong></p><pre>${locationSearchStr || "Vuoto"}</pre>
                `;
            }
    
    
            // --- 2. Gestione Modale Note --- (le tue funzioni vanno bene, le includo per completezza)
            function openNotesModal() {
                if (notesTextareaModal && notesHiddenInput && notesModalOverlay) {
                    notesTextareaModal.value = notesHiddenInput.value;
                    notesModalOverlay.style.display = 'flex';
                    notesTextareaModal.focus();
                }
            }
            function closeNotesModal() {
                if (notesModalOverlay) notesModalOverlay.style.display = 'none';
            }
            function updateNotesDisplay(notesText) {
                if (currentNotesDisplay) {
                    currentNotesDisplay.textContent = (notesText && notesText.trim() !== "") ? notesText.trim() : "Nessuna nota.";
                    currentNotesDisplay.classList.toggle('empty', !(notesText && notesText.trim() !== ""));
                }
            }
            function saveNotesFromModal() {
                if (notesTextareaModal && notesHiddenInput) {
                    const newNotes = notesTextareaModal.value.trim();
                    notesHiddenInput.value = newNotes;
                    updateNotesDisplay(newNotes);
                    closeNotesModal();
                }
            }
            if (addNotesButton) addNotesButton.addEventListener('click', openNotesModal);
            if (cancelNotesButton) cancelNotesButton.addEventListener('click', closeNotesModal);
            if (saveNotesButton) saveNotesButton.addEventListener('click', saveNotesFromModal);
    
    
            // --- 3. Validazione Form ---
            function validateForm() {
                let isValid = true;
                if (missingTimeError) missingTimeError.style.display = 'none';
                if (missingTimeValueInput) missingTimeValueInput.classList.remove('input-error');
    
                if (missingTimeFieldGroup && missingTimeFieldGroup.style.display !== 'none' &&
                    singleCorrectionActionSelect && singleCorrectionActionSelect.value !== '') {
                    if (!missingTimeValueInput || !missingTimeValueInput.value) {
                        if (missingTimeError) {
                            missingTimeError.textContent = "L'orario è obbligatorio.";
                            missingTimeError.style.display = 'block';
                        }
                        if (missingTimeValueInput) missingTimeValueInput.classList.add('input-error');
                        isValid = false;
                    } else if (missingTimeValueInput && !/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(missingTimeValueInput.value)) {
                         if (missingTimeError) {
                            missingTimeError.textContent = "Formato orario non valido (HH:MM).";
                            missingTimeError.style.display = 'block';
                        }
                         if (missingTimeValueInput) missingTimeValueInput.classList.add('input-error');
                         isValid = false;
                    }
                }
                return isValid;
            }
    
            // --- 4. Gestione Invio Form ---
            if (submitHtmlButton) {
                submitHtmlButton.addEventListener('click', function() {
                    if (!validateForm()) {
                        tg.showAlert("Per favore, correggi gli errori nel form.", function() {
                            const firstErrorInput = correctionForm ? correctionForm.querySelector('.input-error') : null;
                            if (firstErrorInput) firstErrorInput.focus();
                        });
                        return;
                    }
    
                    tg.showConfirm("Confermi l'invio della correzione?", function(isConfirmed) {
                        if (isConfirmed) {
                            submitHtmlButton.disabled = true;
                            submitHtmlButton.textContent = "Invio in corso...";
                            if(tg.MainButton.isVisible) tg.MainButton.showProgress();
    
                            const dataToSend = {
                                problemId: problemIdInput ? problemIdInput.value : (initialStartParamData ? initialStartParamData.problemId : ""),
                                problemContextId: initialStartParamData ? initialStartParamData.problemContextId : "", // Passa il context ID ricevuto
                                originalEmployeeName: originalEmployeeNameInput ? originalEmployeeNameInput.value : "",
                                originalProblemDateISO: originalProblemDateISOInput ? originalProblemDateISOInput.value : "",
                                originalSingleTime: originalSingleTimeInput ? originalSingleTimeInput.value : "",
                                correctedDate: correctedDateInput ? correctedDateInput.value : "",
                                singleCorrectionAction: singleCorrectionActionSelect ? singleCorrectionActionSelect.value : "",
                                missingTimeValue: missingTimeValueInput ? missingTimeValueInput.value : "",
                                notes: notesHiddenInput ? notesHiddenInput.value : "",
                                initDataRaw: tg.initData || "",
                                telegramUserId: currentTelegramUserId, // Ora include l'ID utente se letto
                                clientTimestamp: new Date().toISOString(),
                                startParamReceived: startParamValueForDebug // Valore grezzo per debug server
                            };
    
                            console.log("Dati inviati al server:", JSON.stringify(dataToSend, null, 2));
    
                            
                            fetch(GAS_WEB_APP_URL, {
                                                method: 'POST',
                                                redirect: 'follow', // <-- Aggiungi questo
                                                // mode: 'cors', // Puoi commentare o rimuovere mode: 'cors' se usi text/plain,
                                                            // perché text/plain non fa una preflight CORS "vera"
                                                            // ma lasciarlo non dovrebbe fare danno. Prova entrambe le opzioni.
                                                cache: 'no-cache',
                                                headers: {
                                                    // Visto che il payload effettivo è JSON, ma vogliamo bypassare la preflight OPTIONS
                                                    // proviamo con text/plain come suggerito da Stack Overflow.
                                                    'Content-Type': 'text/plain;charset=utf-8',
                                                },
                                                body: JSON.stringify({ payload: dataToSend }) // Il corpo è ancora una stringa JSON
                                            })
                                            .then(response => {
                                                console.log("Risposta RAW dal server (fetch con text/plain):", response);
                                                if (!response.ok) {
                                                    // Se la risposta HTTP non è ok, prova a leggere il corpo come testo
                                                    return response.text().then(text => {
                                                        console.error("Testo della risposta (non OK) dal server (text/plain):", text);
                                                        // Dato che il server GAS dovrebbe comunque rispondere con JSON (anche per errori gestiti)
                                                        // proviamo a parsarlo
                                                        try {
                                                            const errData = JSON.parse(text);
                                                            throw new Error(errData.message || `Errore HTTP ${response.status} - Contenuto: ${text.substring(0,100)}`);
                                                        } catch (parseError) {
                                                            // Se GAS ha restituito un errore HTML (es. errore di script non gestito)
                                                            // o se la risposta non era JSON
                                                            throw new Error(`Errore HTTP ${response.status} - Risposta non JSON o errore server GAS: ${text.substring(0,100)}`);
                                                        }
                                                    });
                                                }
                                                // Se response.ok, GAS dovrebbe aver restituito JSON, quindi proviamo a parsarlo.
                                                // Anche se abbiamo inviato text/plain, il nostro doPost restituisce application/json
                                                return response.json();
                                            })
                                            .then(data => {
                                                console.log('Successo da GAS (con text/plain):', data);
                                                if (data.status === "successo") {
                                                    tg.showAlert(data.message || "Correzione inviata con successo!", function() { tg.close(); });
                                                } else {
                                                    tg.showAlert(`Errore dall'applicazione: ${data.message || 'Sconosciuto.'}`);
                                                    if (submitHtmlButton) {
                                                        submitHtmlButton.disabled = false;
                                                        submitHtmlButton.textContent = "Invia Correzione";
                                                    }
                                                }
                                            })
                                            .catch((error) => {
                                                console.error('ERRORE DETTAGLIATO nel fetch a GAS (con text/plain):', error);
                                                tg.showAlert(`Errore di comunicazione (text/plain): ${error.message}. Controlla console.`);
                                                if (submitHtmlButton) {
                                                    submitHtmlButton.disabled = false;
                                                    submitHtmlButton.textContent = "Invia Correzione";
                                                }
                                            })
                                            .finally(() => {
                                                if(tg.MainButton.isVisible && typeof tg.MainButton.hideProgress === 'function') tg.MainButton.hideProgress();
                                            });
                            
                            
                            fetch(GAS_WEB_APP_URL, {
                                method: 'POST',
                                mode: 'cors',
                                cache: 'no-cache',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ payload: dataToSend }) // Invia come oggetto {payload: ...}
                            })
                            .then(response => {
                                console.log("Risposta RAW dal server (fetch):", response);
                                if (!response.ok) {
                                    return response.text().then(text => { // Leggi come testo prima
                                        console.error("Testo della risposta (non OK) dal server:", text);
                                        try {
                                            const errData = JSON.parse(text); // Prova a parsare come JSON
                                            throw new Error(errData.message || `Errore HTTP ${response.status} - Contenuto: ${text.substring(0,100)}`);
                                        } catch (parseError) { // Se non è JSON o il parsing fallisce
                                            throw new Error(`Errore HTTP ${response.status} - Risposta non JSON: ${text.substring(0,100)}`);
                                        }
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Successo da GAS:', data);
                                if (data.status === "successo") {
                                    tg.showAlert(data.message || "Correzione inviata con successo!", function() { tg.close(); });
                                } else {
                                    tg.showAlert(`Errore dall'applicazione: ${data.message || 'Sconosciuto.'}`);
                                    submitHtmlButton.disabled = false;
                                    submitHtmlButton.textContent = "Invia Correzione";
                                }
                            })
                            .catch((error) => {
                                console.error('ERRORE DETTAGLIATO nel fetch a GAS:', error);
                                tg.showAlert(`Errore di comunicazione: ${error.message}. Controlla console (se possibile).`);
                                submitHtmlButton.disabled = false;
                                submitHtmlButton.textContent = "Invia Correzione";
                            })
                            .finally(() => {
                                if(tg.MainButton.isVisible && typeof tg.MainButton.hideProgress === 'function') tg.MainButton.hideProgress();
                            });
                        }
                    });
                });
            } else {
                console.error("Pulsante di invio 'submitHtmlButton' non trovato nel DOM.");
            }
    
    
            // --- Inizializzazione ---
            let startParamValueForDebug = "Nessuno (non ancora letto)"; // Per il log finale
    
            try {
                if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
                     currentTelegramUserId = String(tg.initDataUnsafe.user.id);
                }
                console.log("Current Telegram User ID:", currentTelegramUserId);
    
                if (tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
                    startParamValueForDebug = tg.initDataUnsafe.start_param;
                } else {
                    const currentUrlParams = new URLSearchParams(window.location.search);
                    const tgWebAppStartParamFromUrl = currentUrlParams.get('tgWebAppStartParam');
                    if (tgWebAppStartParamFromUrl) {
                        startParamValueForDebug = tgWebAppStartParamFromUrl;
                    }
                }
                console.log("startParamValueForDebug letto come:", startParamValueForDebug);
                
                // Verifica per la modalità debug speciale se startapp=debug
                if (startParamValueForDebug && startParamValueForDebug.toLowerCase() === 'debug') {
                    isDebugMode = true;
                    const debugData = {
                        problemId: "DEBUG_ID", employeeName: "Debug User", problemDescription: "Test Problema (Uscita Manc.)",
                        problemTime: "alle 09:00", problemDate: "del Giorno Debug", problemDateISO: new Date().toISOString().split('T')[0],
                        originalSingleTime: "09:00", problemType: "SINGLE_MISSING_EXIT", problemDateFormatted: "Oggi (Debug)",
                        problemContextId: "debug_context_123"
                    };
                    populateUI(debugData);
                } else {
                     const parsedData = parseStartParam(startParamValueForDebug); // startParamValueForDebug contiene il payload base64url
                     populateUI(parsedData);
                }
    
            } catch (initError) {
                showFatalError("Errore durante l'inizializzazione: " + initError.message);
            }
    
            // Mostra sempre la sezione debug se isDebugMode è true, o per utenti specifici
            if (isDebugMode || (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id === 824994510)) {
                 if(debugSection) debugSection.style.display = 'block';
            }
            updateDebugSection(
                startParamValueForDebug,
                initialStartParamData, // Questo è l'oggetto dopo parseStartParam
                tg.initData,
                tg.initDataUnsafe,
                window.location.search
            );
    
        }); // Fine DOMContentLoaded
    </script>

</body>
</html>