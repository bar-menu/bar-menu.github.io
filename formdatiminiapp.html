<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Form Correzione</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Stili Base e Tipografia (come li avevi definiti) */
        html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; margin: 0; padding: 20px; background-color: var(--tg-theme-bg-color, #ffffff); color: var(--tg-theme-text-color, #000000); font-size: 17px; line-height: 1.6; }
        h2 { color: var(--tg-theme-text-color); border-bottom: 1px solid var(--tg-theme-hint-color); padding-bottom: 12px; margin-top: 0; margin-bottom: 25px; font-size: 1.4em; font-weight: 600; text-align: center; }
        label { display: block; margin-top: 20px; margin-bottom: 8px; font-weight: 500; font-size: 0.95em; color: var(--tg-theme-hint-color); }
        input[type="text"], input[type="date"], input[type="time"], textarea, select { width: 100%; padding: 14px 12px; margin-top: 0; border: 1.5px solid var(--tg-theme-hint-color, #cccccc); border-radius: 10px; background-color: var(--tg-theme-secondary-bg-color, #f9f9f9); color: var(--tg-theme-text-color); box-sizing: border-box; font-size: 1em; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        select { padding: 14px 12px; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007AFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 12px auto; }
        input[readonly] { background-color: var(--tg-theme-secondary-bg-color, #eeeeee); opacity: 0.7; border-color: var(--tg-theme-hint-color, #dddddd); }
        input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus, textarea:focus, select:focus { border-color: var(--tg-theme-button-color, #2481CC); box-shadow: 0 0 0 3px var(--tg-theme-button-color-alpha, rgba(36, 129, 204, 0.25)); outline: none; }
        :root { --tg-theme-button-color-alpha: rgba(36, 129, 204, 0.25); --tg-theme-destructive-text-color-alpha: rgba(255, 77, 77, 0.25); }
        input.input-error, select.input-error { border-color: var(--tg-theme-destructive-text-color, #ff4d4d) !important; box-shadow: 0 0 0 3px var(--tg-theme-destructive-text-color-alpha, rgba(255, 77, 77, 0.25)) !important; }
        .error-message { font-size: 0.8em; color: var(--tg-theme-destructive-text-color, #ff4d4d); margin-top: 4px; min-height: 1.2em;}
        textarea { min-height: 100px; resize: vertical; }
        .info-summary { background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); padding: 15px; border-radius: 10px; margin-bottom: 25px; border: 1px solid var(--tg-theme-hint-color, #e0e0e0); }
        .info-summary p { margin: 5px 0 10px 0; font-size: 1em; display: flex; align-items: baseline; }
        .info-summary .info-label { font-weight: 500; color: var(--tg-theme-hint-color); margin-right: 8px; font-size: 0.9em; flex-shrink: 0; }
        .info-summary .info-value { font-weight: 600; color: var(--tg-theme-text-color); }
        #summaryEmployeeName.info-value { text-transform: uppercase; padding: 2px 6px; border-radius: 4px; font-size: 0.95em; }
        .info-summary .problem-details-container { margin: 5px 0 10px 0; font-size: 1em; display: flex; align-items: flex-start; }
        .problem-value-multiline #problemType, .problem-value-multiline #problemTime, .problem-value-multiline #problemDateText { display: block; line-height: 1.4;}
        .problem-value-multiline #problemTime { font-weight: normal; }
        .problem-value-multiline #problemDateText { font-weight: 600; } 
        .field-group { margin-bottom: 20px; }
        .date-info-text { font-size: 0.8em; color: var(--tg-theme-hint-color); margin-top: 4px; font-style: italic; }
        #missingTimeDateContext { font-size: 0.85em; color: var(--tg-theme-hint-color); margin-left: 8px; font-style: italic; min-height: 1.2em;}
        #submitHtmlButton, .modal-button { background-color: var(--tg-theme-button-color, #2481CC); color: var(--tg-theme-button-text-color, #FFFFFF); padding: 14px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; transition: background-color 0.2s ease, opacity 0.2s ease, transform 0.1s ease; }
        #submitHtmlButton { padding: 16px 20px; font-size: 1.1em; font-weight: 600; width: 100%; margin-top: 30px; text-transform: uppercase; letter-spacing: 0.5px; }
        #addNotesButton { background-color: transparent; color: var(--tg-theme-hint-color, #707579); border: 1.5px solid var(--tg-theme-hint-color, #adb5bd); padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 500; width: auto; display: inline-block; margin-top: 10px; margin-bottom: 5px; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; }
        #addNotesButton:hover:not(:disabled) { background-color: var(--tg-theme-secondary-bg-color, rgba(0,0,0,0.05)); border-color: var(--tg-theme-text-color); color: var(--tg-theme-text-color); }
        #submitHtmlButton:hover:not(:disabled), .modal-button:hover:not(:disabled) { opacity: 0.85; }
        #submitHtmlButton:active:not(:disabled) { transform: scale(0.98); }
        #submitHtmlButton:disabled { background-color: var(--tg-theme-hint-color, #cccccc); color: var(--tg-theme-secondary-bg-color, #666666); cursor: not-allowed; opacity: 0.7; }
        #loadingMessage, #errorMessage { text-align: center; padding: 30px 20px; font-style: italic; font-size: 1em; color: var(--tg-theme-hint-color); }
        #errorMessage { color: var(--tg-theme-destructive-text-color, red); font-weight: bold; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background-color: var(--tg-theme-secondary-bg-color, #ffffff); padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); color: var(--tg-theme-text-color); }
        .modal-content textarea { width: 100%; min-height: 80px; margin-bottom: 15px; border-color: var(--tg-theme-hint-color); background-color: var(--tg-theme-bg-color); }
        .modal-content label { margin-top: 0; margin-bottom: 5px; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        .modal-button.secondary { background-color: var(--tg-theme-hint-color, #ccc); color: var(--tg-theme-text-color, #333); }
        #currentNotesDisplay { font-size: 0.9em; color: var(--tg-theme-text-color); margin-top: 0px; padding: 8px; background-color: var(--tg-theme-bg-color); border-radius: 6px; border: 1px dashed var(--tg-theme-hint-color, #e0e0e0); min-height: 20px; white-space: pre-wrap; word-wrap: break-word; }
        #currentNotesDisplay.empty { font-style: italic; color: var(--tg-theme-hint-color); }
        #debugSection { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--tg-theme-hint-color); }
        #debugSection h3 { font-size: 1.1em; text-align: left; border-bottom: none; margin-bottom: 10px; }
        #debugSection p { font-size: 0.9em; margin: 5px 0; }
        #debugSection pre { background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); padding: 10px; border: 1px solid var(--tg-theme-hint-color, #e0e0e0); border-radius: 6px; font-size: 0.85em; word-wrap: break-word; white-space: pre-wrap; }
    </style>
</head>
<body style="visibility: hidden;">
    <div id="formContainer" style="display: none;">
        <h2>Form Correzione</h2>
        <div class="info-summary">
            <p><span class="info-label">Dipendente:</span><strong id="summaryEmployeeName" class="info-value">N/D</strong></p>
            <div class="problem-details-container">
                <span class="info-label">Problema:</span>
                <div id="summaryProblemFullDescription" class="info-value problem-value-multiline">
                    <span id="problemType">N/D</span>
                    <span id="problemTime">N/D</span>
                    <span id="problemDateText">N/D</span>
                </div>
            </div>
        </div>
        <form id="correctionForm">
            <!-- Questi campi hidden saranno popolati da populateUI e i loro valori 
                 inviati al GAS con i nomi attributo 'name' specificati -->
            <input type="hidden" id="problemContextIdInput" name="problemContextId"> <!-- Sarà popolato con data.ctxId -->
            <input type="hidden" id="originalEmployeeNameInput" name="originalEmployeeName">
            <input type="hidden" id="originalProblemDateISOInput" name="originalProblemDateISO">
            <input type="hidden" id="originalSingleTimeInput" name="originalSingleTime">
            <input type="hidden" id="originalSingleBarInput" name="originalSingleBar">

            <!-- Non è più necessario problemIdInput se problemContextIdInput fa lo stesso lavoro -->
            <!-- <input type="hidden" id="problemIdInput" name="problemId"> --> 
            
            <input type="hidden" id="notesHiddenInput" name="notes">
            <input type="hidden" id="correctorUserIdInput" name="correctorUserId">
            <input type="hidden" id="correctorUserNameInput" name="correctorUserName">
            <input type="hidden" id="correctorUserFirstNameInput" name="correctorUserFirstName">
            <input type="hidden" id="correctorUserLastNameInput" name="correctorUserLastName">

            <div class="field-group" id="dateCorrectionGroup" style="display:none;">
                <label for="correctedDate">Data Corretta (lascia vuoto per deduzione):</label>
                <input type="date" id="correctedDate" name="correctedDate">
                <p class="date-info-text">La data verrà dedotta automaticamente se possibile.</p>
            </div>
            <div class="field-group" id="singleTimeCorrectionSection" style="display:none;">
                <label for="singleCorrectionAction">Aggiungere:</label>
                <select id="singleCorrectionAction" name="singleCorrectionAction">
                    <option value="">-- Seleziona un'azione --</option>
                    <option value="isEntry_addExit">Uscita Mancante</option>
                    <option value="isExit_addEntry">Entrata Mancante</option>
                </select>
                 <div id="singleCorrectionActionError" class="error-message" style="display:none;"></div>
            </div>
            <div class="field-group" id="missingTimeFieldGroup" style="display:none;">
                <div style="display: flex; align-items: center;">
                    <div style="flex-grow: 1;">
                        <label for="missingTimeValue" id="missingTimeLabel">Orario Mancante (HH:MM):</label>
                        <input type="time" id="missingTimeValue" name="missingTimeValue">
                        <div id="missingTimeError" class="error-message" style="display:none;"></div>
                    </div>
                    <span id="missingTimeDateContext"></span>
                </div>
            </div>
            <div class="field-group">
                <button type="button" id="addNotesButton">Aggiungi Note (opzionale)</button>
                <div id="currentNotesDisplay" class="empty">Nessuna nota.</div>
            </div>
            <div class="field-group" style="margin-top: 30px;">
                <button type="button" id="submitHtmlButton">Invia Correzione</button>
            </div>
        </form>
    </div>
    <div id="notesModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <label for="notesTextareaModal">Inserisci le tue note:</label>
            <textarea id="notesTextareaModal" name="notesTextareaModal" rows="4"></textarea>
            <div class="modal-buttons">
                <button type="button" id="cancelNotesButton" class="modal-button secondary">Annulla</button>
                <button type="button" id="saveNotesButton" class="modal-button">Salva Note</button>
            </div>
        </div>
    </div>
    <div id="loadingMessage">Caricamento dati...</div>
    <div id="errorMessage" style="display:none;"></div>
    <div id="debugSection" style="display: none;"></div>

   <!-- **** INIZIO DEL BLOCCO JAVASCRIPT DA SOSTITUIRE **** -->
   <script>
    document.addEventListener('DOMContentLoaded', function () {
        const tg = window.Telegram.WebApp;
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby2qm7YA_UPHA1TAz2UYRLEzL5uukraSYQXYaC5t8dxHVydezV3pvi-xawyf9qHr4lg/exec'; // VERIFICA QUESTO URL!

        // --- RIFERIMENTI AGLI ELEMENTI DEL FORM (adatta ai tuoi ID) ---
        const formContainer = document.getElementById('formContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessageDiv = document.getElementById('errorMessage');
        const debugSection = document.getElementById('debugSection'); // Se lo usi

        // Campi input (assicurati che gli ID corrispondano al tuo HTML)
        const problemContextIdInput = document.getElementById('problemContextIdInput');
        const originalEmployeeNameInput = document.getElementById('originalEmployeeNameInput');
        const originalProblemDateISOInput = document.getElementById('originalProblemDateISOInput');
        const originalSingleTimeInput = document.getElementById('originalSingleTimeInput');
        const originalSingleBarInput = document.getElementById('originalSingleBarInput');
        const correctedDateInput = document.getElementById('correctedDate');
        const singleCorrectionActionSelect = document.getElementById('singleCorrectionAction');
        const missingTimeValueInput = document.getElementById('missingTimeValue');
        const notesHiddenInput = document.getElementById('notesHiddenInput');
        // ... aggiungi altre costanti per i tuoi elementi, es. summaryEmployeeName, problemTypeSpan, ecc.
        const summaryEmployeeName = document.getElementById('summaryEmployeeName');
        const problemTypeSpan = document.getElementById('problemType');
        const problemTimeSpan = document.getElementById('problemTime');
        const problemDateTextSpan = document.getElementById('problemDateText');
        const singleCorrectionActionError = document.getElementById('singleCorrectionActionError');
        const missingTimeLabel = document.getElementById('missingTimeLabel');
        const missingTimeDateContext = document.getElementById('missingTimeDateContext');
        const missingTimeError = document.getElementById('missingTimeError');
        const dateCorrectionGroup = document.getElementById('dateCorrectionGroup');
        const singleTimeCorrectionSection = document.getElementById('singleTimeCorrectionSection');
        const missingTimeFieldGroup = document.getElementById('missingTimeFieldGroup');
        const addNotesButton = document.getElementById('addNotesButton');
        const currentNotesDisplay = document.getElementById('currentNotesDisplay');
        const notesModalOverlay = document.getElementById('notesModalOverlay');
        const notesTextareaModal = document.getElementById('notesTextareaModal');
        const saveNotesButton = document.getElementById('saveNotesButton'); // Se lo usi ancora
        const cancelNotesButton = document.getElementById('cancelNotesButton'); // Se lo usi ancora


        let initialStartParamData = null;
        let currentUserDetails = { id: null, username: "", first_name: "", last_name: "" };
        let startParamValueForDebug = "Nessuno (non letto)";
        let isDebugMode = false; // Da usare se hai una logica di debug


        // --- FUNZIONI FEEDBACK APTICO ---
        function triggerHapticFeedback(type) {
            if (tg && tg.HapticFeedback && typeof tg.HapticFeedback.impactOccurred === 'function') {
                try { tg.HapticFeedback.impactOccurred(type); console.log(`Haptic impact: ${type}`); }
                catch (e) { console.warn(`Haptic impact error (${type}):`, e); }
            } else { console.log("Haptic impact N/A."); }
        }
        function triggerNotificationFeedback(type) {
            if (tg && tg.HapticFeedback && typeof tg.HapticFeedback.notificationOccurred === 'function') {
                try { tg.HapticFeedback.notificationOccurred(type); console.log(`Haptic notification: ${type}`); }
                catch (e) { console.warn(`Haptic notification error (${type}):`, e); }
            } else { console.log("Haptic notification N/A."); }
        }

        // --- UTILITY FUNCTIONS (base64UrlDecode, parseStartParam, setThemeClass, hexToRgba, applyThemeVariables) ---
        // (Incolla qui le tue funzioni utility esistenti se non sono già definite sopra o se sono necessarie)
        function setThemeClass() { if (tg && tg.colorScheme) { document.documentElement.className = tg.colorScheme; } else { console.warn("setThemeClass: tg o tg.colorScheme non definiti.");} }
        function hexToRgba(hex, alpha) { if(!hex || typeof hex !== 'string') hex = '#000000'; hex=hex.replace('#',''); const r=parseInt(hex.substring(0,2),16)||0; const g=parseInt(hex.substring(2,4),16)||0; const b=parseInt(hex.substring(4,6),16)||0; return `rgba(${r},${g},${b},${alpha})`;}
        function applyThemeVariables() { const rootStyle=document.documentElement.style; if (!tg || !tg.themeParams) { console.warn("applyThemeVariables: tg o tg.themeParams non definiti."); return; } const buttonColor=tg.themeParams.button_color||'#2481CC'; const destructiveColor=tg.themeParams.destructive_text_color||'#ff4d4d'; rootStyle.setProperty('--tg-theme-button-color-alpha',hexToRgba(buttonColor,0.25)); rootStyle.setProperty('--tg-theme-destructive-text-color-alpha',hexToRgba(destructiveColor,0.25));}
        function base64UrlDecode(str) { if(!str||typeof str!=='string'||str.trim()==="")return null; try{let base64=str.replace(/-/g,'+').replace(/_/g,'/'); while(base64.length%4){base64+='=';} return decodeURIComponent(atob(base64).split('').map(function(c){return '%'+('00'+c.charCodeAt(0).toString(16)).slice(-2);}).join(''));}catch(e){console.error("Errore base64UrlDecode:",e,"Stringa:",str);return null;}}
        function parseStartParam(startParamString) { /* ... la tua implementazione ... */ if(!startParamString||startParamString==="Nessuno"||startParamString.trim()===""){console.error("parseStartParam: Parametro avvio mancante."); return{error:"Parametro di avvio mancante."};} const decodedJsonString=base64UrlDecode(startParamString); if(!decodedJsonString){console.error("parseStartParam: Decodifica Base64 fallita."); return{error:"Decodifica parametro fallita."};} try{return JSON.parse(decodedJsonString);} catch(e){console.error("parseStartParam: Errore Parsing JSON.");return{error:"Formato dati non valido (JSON)."};} }
        function isValidTimeFormat(timeString) { return timeString && /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString); }
        function formatDate_DDMMYYYY(dateStrYYYYMMDD) { if (!dateStrYYYYMMDD || typeof dateStrYYYYMMDD !== 'string') return ""; const parts = dateStrYYYYMMDD.split('-'); if (parts.length !== 3) return dateStrYYYYMMDD; return `${parts[2]}-${parts[1]}-${parts[0]}`; }


        // --- FUNZIONI DI GESTIONE DEL FORM (validateForm, handleSingleCorrectionActionChange, updateMissingTimeDateContext) ---
        // (Incolla qui le tue funzioni esistenti per la logica del form)
        function updateMissingTimeDateContext() { /* ... la tua implementazione ... */ }
        function handleSingleCorrectionActionChange() { /* ... la tua implementazione ... */ }
        function validateForm() { /* ... la tua implementazione di validazione form ... ritorna true o false */ return true; /* placeholder */ }

        // --- FUNZIONI PER MODALE NOTE (openNotesModal, closeNotesModal, saveNotesFromModal) ---
        // (Incolla qui le tue funzioni esistenti se usi ancora il modale delle note)
        function openNotesModal() { if(notesTextareaModal && notesHiddenInput && notesModalOverlay){notesTextareaModal.value = notesHiddenInput.value; notesModalOverlay.style.display = 'flex'; notesTextareaModal.focus();} }
        function closeNotesModal() { if(notesModalOverlay) notesModalOverlay.style.display = 'none'; }
        function saveNotesFromModal() { if(notesTextareaModal && notesHiddenInput && currentNotesDisplay){const notesTrimmed = notesTextareaModal.value.trim(); notesHiddenInput.value = notesTrimmed; if (notesTrimmed) { currentNotesDisplay.textContent = notesTrimmed; currentNotesDisplay.classList.remove('empty'); }  else { currentNotesDisplay.textContent = "Nessuna nota."; currentNotesDisplay.classList.add('empty'); } closeNotesModal(); }}

        // --- PREPARAZIONE DATI PER INVIO (Helper function) ---
        function prepareDataForGAS() {
            // Assicurati che tutti gli input qui referenziati siano definiti sopra
            return {
                problemContextId: problemContextIdInput?.value || '',
                originalEmployeeName: originalEmployeeNameInput?.value || '',
                originalProblemDateISO: originalProblemDateISOInput?.value || '',
                originalSingleTime: originalSingleTimeInput?.value || '',
                originalSingleBar: originalSingleBarInput?.value || '',
                correctedDate: correctedDateInput?.value || '',
                singleCorrectionAction: singleCorrectionActionSelect?.value || '',
                missingTimeValue: missingTimeValueInput?.value || '',
                notes: notesHiddenInput?.value || '',
                initDataRaw: tg.initData || "",
                telegramUserId: currentUserDetails.id,
                correctorUserInfo: currentUserDetails,
                clientTimestamp: new Date().toISOString(),
                startParamReceived: startParamValueForDebug
            };
        }

        // --- AZIONE CLICK DEL MAINBUTTON (INVIA) ---
        function handleMainButtonClick() {
            triggerHapticFeedback('light');
            if (!validateForm()) {
                triggerNotificationFeedback('error');
                tg.showAlert("Per favore, correggi gli errori nel form.", function() {
                    const firstErrorInput = document.querySelector('#correctionForm .input-error');
                    if (firstErrorInput) firstErrorInput.focus();
                });
                return;
            }
            tg.showConfirm("Confermi l'invio della correzione?", function(isConfirmed) {
                if (isConfirmed) {
                    triggerHapticFeedback('medium');
                    if (tg.MainButton) { tg.MainButton.showProgress(false); tg.MainButton.disable(); }
                    if (Telegram.WebApp.hasOwnProperty('SecondaryButton') && tg.SecondaryButton?.isVisible) { tg.SecondaryButton.disable(); }

                    const dataToSend = prepareDataForGAS();
                    console.log("Invio a GAS (via MainButton):", JSON.stringify(dataToSend, null, 2));
                    fetch(GAS_WEB_APP_URL, { method: 'POST', redirect: 'follow', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ payload: dataToSend }) })
                    .then(response => { if (!response.ok) { return response.text().then(text => { try { const errData = JSON.parse(text); throw new Error(errData.message || `Errore HTTP ${response.status}`); } catch (parseError) { throw new Error(`Errore HTTP ${response.status} - Risposta non JSON`); }}); } return response.json(); })
                    .then(data => {
                        console.log('GAS OK:', data);
                        if (tg.MainButton) tg.MainButton.hideProgress();
                        if (data.status === "successo") {
                            triggerNotificationFeedback('success');
                            if (tg.MainButton) tg.MainButton.setText("INVIATO!");
                            if (Telegram.WebApp.hasOwnProperty('SecondaryButton') && tg.SecondaryButton?.isVisible) tg.SecondaryButton.hide();
                            tg.showAlert(data.message || "Correzione inviata!", function() { tg.close(); });
                        } else {
                            triggerNotificationFeedback('error');
                            if (tg.MainButton) { tg.MainButton.setText("ERRORE INVIO"); tg.MainButton.enable(); }
                            if (Telegram.WebApp.hasOwnProperty('SecondaryButton') && tg.SecondaryButton?.isVisible) { tg.SecondaryButton.setText("ANNULLA"); tg.SecondaryButton.enable(); }
                            tg.showAlert(`Errore App: ${data.message || 'Sconosciuto.'}`);
                        }
                    })
                    .catch((error) => {
                        console.error('Errore Fetch GAS:', error);
                        triggerNotificationFeedback('error');
                        if (tg.MainButton) { tg.MainButton.hideProgress(); tg.MainButton.setText("ERRORE RETE"); tg.MainButton.enable(); }
                        if (Telegram.WebApp.hasOwnProperty('SecondaryButton') && tg.SecondaryButton?.isVisible) { tg.SecondaryButton.setText("ANNULLA"); tg.SecondaryButton.enable(); }
                        tg.showAlert(`Errore Comunicazione: ${error.message}.`);
                    });
                } else {
                    triggerHapticFeedback('light');
                }
            });
        }

        // --- AZIONE CLICK DEL SECONDARYBUTTON (ANNULLA) ---
        function handleSecondaryButtonClick() {
            triggerHapticFeedback('light');
            tg.showConfirm("Vuoi annullare e chiudere il form?", function(isConfirmed) {
                if (isConfirmed) { triggerHapticFeedback('medium'); tg.close(); }
                else { triggerHapticFeedback('light'); }
            });
        }

        // --- FUNZIONI UI (populateUI, showFatalError, updateDebugSection) ---
        function updateDebugSection(startParamVal, parsedDataObj, initDataStr, initDataUnsafeObj, locationSearchStr, extraError = "") {
            if (!debugSection) return;
            let debugContent = `<h3>Debug Info:</h3>
                <p><strong>Start Param (raw):</strong></p><pre>${String(startParamVal)}</pre>
                <p><strong>Parsed Start Param:</strong></p><pre>${parsedDataObj ? JSON.stringify(parsedDataObj, null, 2) : "N/D"}</pre>
                <p><strong>initData:</strong></p><pre>${initDataStr || "N/D"}</pre>
                <p><strong>initDataUnsafe:</strong></p><pre>${initDataUnsafeObj ? JSON.stringify(initDataUnsafeObj, null, 2) : "N/D"}</pre>
                <p><strong>URL Search:</strong></p><pre>${locationSearchStr || "N/D"}</pre>`;
            if (extraError) debugContent += `<p><strong>Extra Error:</strong></p><pre style="color:red;">${extraError}</pre>`;
            debugSection.innerHTML = debugContent;
        }

        function showFatalError(message, startParamVal, parsedData, initData, initUnsafe, locSearch) {
            if (loadingMessage) loadingMessage.style.display = 'none';
            if (formContainer) formContainer.style.display = 'none';
            if (errorMessageDiv) { errorMessageDiv.textContent = "ERRORE AVVIO: " + message; errorMessageDiv.style.display = 'block'; }
            console.error("FATAL ERROR MiniApp:", message);

            if (tg.MainButton?.isVisible) tg.MainButton.hide();
            if (Telegram.WebApp.hasOwnProperty('SecondaryButton') && tg.SecondaryButton?.isVisible) tg.SecondaryButton.hide();
            
            if (debugSection) debugSection.style.display = 'block';
            updateDebugSection(startParamVal, parsedData, initData, initUnsafe, locSearch, "ERRORE FATALE: " + message);
            document.body.style.visibility = 'visible';
        }

        function populateUI(data) {
            console.log("populateUI - Dati Input:", JSON.stringify(data));
            if (!data || data.error) {
                showFatalError(`Dati iniziali non validi. ${data?.error || ''}`, startParamValueForDebug, data, tg.initData, tg.initDataUnsafe, window.location.search);
                return;
            }
            initialStartParamData = data;

            // POPOLA I CAMPI DEL FORM CON 'data'
            // Esempio: (ADATTA QUESTO ALLA STRUTTURA DEI TUOI DATI 'data' e agli ID HTML)
            if(summaryEmployeeName) summaryEmployeeName.textContent = data.name || 'N/D';
            if(problemTypeSpan) { /* Logica per problemTypeSpan */ }
            if(problemTimeSpan) { /* Logica per problemTimeSpan */ }
            if(problemDateTextSpan) { /* Logica per problemDateTextSpan */ }

            if(problemContextIdInput) problemContextIdInput.value = data.ctxId || '';
            if(originalEmployeeNameInput) originalEmployeeNameInput.value = data.name || '';
            if(originalProblemDateISOInput) originalProblemDateISOInput.value = data.pDateISO || '';
            if(originalSingleTimeInput) originalSingleTimeInput.value = data.origTime || '';
            if(originalSingleBarInput) originalSingleBarInput.value = data.origBar || '';

            // Popola info utente correttore
            // ... (currentUserDetails dovrebbe essere già popolato) ...

            // Logica per mostrare/nascondere sezioni condizionali del form
            // (come singleTimeCorrectionSection, dateCorrectionGroup) basata su data.pType
            if (singleTimeCorrectionSection && data.pType?.toUpperCase() === 'SINGLE_TIMESTAMP') {
                singleTimeCorrectionSection.style.display = 'block';
                if (data.origTime && singleCorrectionActionSelect) {
                    const hour = parseInt(data.origTime.split(':')[0], 10);
                    if (!isNaN(hour)) singleCorrectionActionSelect.value = (hour < 14) ? 'isEntry_addExit' : 'isExit_addEntry';
                    else singleCorrectionActionSelect.value = '';
                } else if (singleCorrectionActionSelect) {
                    singleCorrectionActionSelect.value = '';
                }
                handleSingleCorrectionActionChange(); // Aggiorna UI dei campi dipendenti
            } else if (singleTimeCorrectionSection) {
                singleTimeCorrectionSection.style.display = 'none';
            }
            // Altre logiche per pType...

            if (loadingMessage) loadingMessage.style.display = 'none';
            if (errorMessageDiv) errorMessageDiv.style.display = 'none';
            if (formContainer) formContainer.style.display = 'block';
            document.body.style.visibility = 'visible';

            // Configura e mostra i pulsanti nativi
            if (tg.MainButton) {
                tg.MainButton.setParams({ text: 'INVIA CORREZIONE', color: tg.themeParams.button_color, text_color: tg.themeParams.button_text_color, is_visible: true, is_active: true });
                tg.MainButton.offClick(handleMainButtonClick).onClick(handleMainButtonClick);
            } else {
                showFatalError("MainButton non disponibile."); return;
            }

            if (Telegram.WebApp.hasOwnProperty('SecondaryButton')) {
                tg.SecondaryButton.setParams({ text: 'ANNULLA', color: tg.themeParams.secondary_bg_color || '#e0e0e0', text_color: tg.themeParams.text_color, is_visible: true, is_active: true });
                tg.SecondaryButton.offClick(handleSecondaryButtonClick).onClick(handleSecondaryButtonClick);
            } else {
                console.warn("SecondaryButton non disponibile.");
                // Nessun fallback HTML per SecondaryButton in questo scenario, l'utente userà il BackButton
            }
            
            if (debugSection) updateDebugSection(startParamValueForDebug, initialStartParamData, tg.initData, tg.initDataUnsafe, window.location.search);
        }


        // --- BLOCCO DI INIZIALIZZAZIONE PRINCIPALE ---
        try {
            console.log("Avvio Inizializzazione Mini App (con Main/Secondary Buttons)...");
            if (!tg) { showFatalError("Oggetto Telegram WebApp non disponibile."); throw new Error("TG WebApp non trovato"); }
            
            tg.onEvent('themeChanged', function() {
                setThemeClass(); applyThemeVariables(); // Le tue funzioni
                if (tg.MainButton?.isVisible) { tg.MainButton.setParams({ color: tg.themeParams.button_color, text_color: tg.themeParams.button_text_color }); }
                if (Telegram.WebApp.hasOwnProperty('SecondaryButton') && tg.SecondaryButton?.isVisible) { tg.SecondaryButton.setParams({ color: tg.themeParams.secondary_bg_color, text_color: tg.themeParams.text_color }); }
            });
            setThemeClass(); applyThemeVariables();

            tg.ready();
            tg.expand();

            if (tg.BackButton) {
                tg.BackButton.show();
                tg.BackButton.onClick(function() { triggerHapticFeedback('light'); tg.showConfirm("Uscire senza salvare?", (ok) => { if(ok) tg.close(); }); });
            }

            if (tg.initDataUnsafe?.user) {
                currentUserDetails.id = String(tg.initDataUnsafe.user.id);
                currentUserDetails.username = tg.initDataUnsafe.user.username || "";
                currentUserDetails.first_name = tg.initDataUnsafe.user.first_name || "";
                currentUserDetails.last_name = tg.initDataUnsafe.user.last_name || "";
            }

            const usp = new URLSearchParams(window.location.search);
            startParamValueForDebug = tg.initDataUnsafe?.start_param || usp.get('tgWebAppStartParam') || "Nessuno (non letto)";
            
            // Abilita debug mode se ?debug=true o se utente specifico
            isDebugMode = (usp.get('debug') === 'true') || (currentUserDetails.id === 'IL_TUO_ID_TELEGRAM_PER_DEBUG'); // SOSTITUISCI
            if (isDebugMode && debugSection) debugSection.style.display = 'block';


            if (startParamValueForDebug && startParamValueForDebug !== "Nessuno (non letto)") {
                if (startParamValueForDebug === 'debug_test_payload') { // PER TEST LOCALE SENZA TELEGRAM
                     console.warn("MODALITÀ DEBUG TEST PAYLOAD ATTIVA");
                     isDebugMode = true; if (debugSection) debugSection.style.display = 'block';
                     const debugData = {"ctxId":"NOME_COGNOME_2024-07-28_1722184934846","name":"NOME COGNOME","pDateISO":"2024-07-28","pType":"SINGLE_TIMESTAMP","origTime":"08:00","origBar":"N"}; // Esempio
                     populateUI(debugData);
                } else {
                    const parsedData = parseStartParam(startParamValueForDebug);
                    populateUI(parsedData);
                }
            } else {
                showFatalError("Parametro di avvio (start_param) non trovato.", startParamValueForDebug, null, tg.initData, tg.initDataUnsafe, window.location.search);
                return;
            }
            
            // Setup event listeners per i campi del form (come avevi prima)
            if(addNotesButton) addNotesButton.addEventListener('click', openNotesModal);
            if(saveNotesButton) saveNotesButton.addEventListener('click', saveNotesFromModal);
            if(cancelNotesButton && notesModalOverlay) cancelNotesButton.addEventListener('click', closeNotesModal); // Bottone 'Annulla' del modale note
            if(singleCorrectionActionSelect) singleCorrectionActionSelect.addEventListener('change', handleSingleCorrectionActionChange);
            if(missingTimeValueInput) {
                missingTimeValueInput.addEventListener('input', function() { if(this.classList) this.classList.remove('input-error'); if(missingTimeError) missingTimeError.style.display = 'none'; updateMissingTimeDateContext(); });
                missingTimeValueInput.addEventListener('blur', function() { validateForm(); });
            }
            
            console.log("Inizializzazione Mini App completata.");

        } catch (initError) {
            console.error("Errore CRITICO Inizializzazione:", initError, initError.stack);
            showFatalError(initError.message + (initError.stack ? ` Stack: ${initError.stack.substring(0,250)}...` : ""), startParamValueForDebug, null, tg.initData, tg.initDataUnsafe, window.location.search);
        }
    });
    </script>
    <!-- **** FINE DEL BLOCCO JAVASCRIPT DA SOSTITUIRE **** -->
</body>
</html>